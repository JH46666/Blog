# 小程序优化指南

## 性能预估

1. 预估性能问题
2. 监控性能问题
3. 使用工具排查问题
4. 实施性能解决方案

我们可以用微信开发者工具自带的评分
![开发者评分](https://tva1.sinaimg.cn/large/006tNbRwgy1g9ziv7pxgsj313c0u077h.jpg)

这是它的评分点：
![评分点](https://tva1.sinaimg.cn/large/006tNbRwgy1ga21bv81h2j30pr0pmmxn.jpg)

## 常见优化方法

1. 从资源包入手，图片的压缩。
我们根据设备的不同特性去选择最优的压缩率，例如  jpg、webp，375*大图 小图,iconfont

* tinypng[https://tinypng.com/]
* yasuotu[https://yasuotu.com/]
* pngcrush[https://pngcrush.com/]

上面放几个比较常用的链接：
2. 利用GPU
将 translate 等消耗gpu的图片变换替代改变宽、高等计算位置
3. 分包大小
受限于小程序的主包不能超过2M,所以我们只能将活动页放置于分包中，下面是我的分包设置。

```js
project
|────src
    | Thanks
        | pages
        | components
        | styles
        └ utils
    | pages
    | utils
    | styles
    | components
    | app.js
    └ APP.vue

└───project.config.json
```

app.js的配置如下

```json
config:{
  pages:[
    "pages/home/index", // 首页
  ],
  subPackages: [
    {
      root: "Thanks",
      pages: [
        "pages/home/index",// 首页
      ],
      independent: true
    }
  ],
}

```
4. 按需引入代码和资源

  在开发中， 我们可能引入一些新的库文件去使用其具体的方法等，这时候如果用到按需引入会更优。

```js
import dayjs from 'dayjs' // load on demand
import 'dayjs/locale/zh-cn' // 按需加载
```

  自定义方法可以采用

```js
//index.js
export function promisify(fn) {

}

export default {
  promisify
}
//request.js
import { promisify } from "@/utils/index";
```

5. global替代vuex

  wxStorage 在配合上 global 取代 vuex,没有必要为了用 vuex 而用 vuex，小程序自带的 global 就够了。

```js
    // 调用
   const { user } = getApp().globalData;
   // 存储
    getApp().globalData.user = user;
```

 缓存是将一些常用的或者上一次请求回来的数据做保存，如 banner，用户信息等。

```js
  function setWxStorage(key, data) {
    wx.setStorage({
      key,
      data
    });
  }
  function getWxStorage(key) {
    try {
      const value = wx.getStorageSync(key)
      if (value) {
        return value
        // Do something with return value
      }
    } catch (e) {
      console.log('e: ', e);
      // Do something when catch error
    }
  }
```

6. 请求的封装

```js
function get(url) {
  this.then = function (resolve, reject) {
    if (url == '/tips') {
      // 避免重复弹出窗口，不做数据缓存
    } else if (url == '/user') {
      // 未授权用户，不做数据缓存
      let user = getWxStorage(url);
      if (user && user.aliasName){
        value && typeof resolve === 'function' && resolve.call(this, user)
      }
    } else {
      let value = getWxStorage(url)
      value && typeof resolve === 'function' && resolve.call(this, value)
    }
    request(url).then(res => {
      typeof resolve === 'function' && resolve.call(this, res)
      setWxStorage(url, res)
    }).catch(err => {
      typeof reject === 'function' && reject.call(this, err)
      throw err
    })
  }
  return this;
}

```

7. iphone刘海屏上下适配

获取屏幕高度

```js

template
      <scroll-view
        scroll-y
        :style="`height: ${scrolHeight}px`"
        @scrolltolower="scrolltolower"
      >
    </scroll-view>
js
    getScroll() {
      const query = wx.createSelectorQuery();
      const res = query
        .select(".bar")
        .boundingClientRect()
        .exec(
          function(res) {
            let barHeight = res[0].height;
            let systemInfo = wx.getSystemInfoSync();
            this.scrolHeight = systemInfo.windowHeight - barHeight;
          }.bind(this)
        );
    },

```

获取tabbar高度

```js
    const model = wx.getSystemInfoSync().model;
    if(model.match("iPhone X")){
      this.isIpx = true;
    }

// 动态类

.fix-iphonex-icon {
  height: 142rpx;
  padding:32rpx 86rpx 80rpx;
}
```

自定义导航栏高度

```js
      let res = wx.getSystemInfoSync();
      // 导航栏总高度 & 占位块高度
      // {
      //       'iPhone': 64,
      //       'iPhoneX': 88,
      //       'Android': 68,
      //       'samsung': 72
      // }
      let isiOS = res.system.indexOf("iOS") > -1;
      let totalBar;
      if (!isiOS) {
        const model = res.model;
        if (model.match("samsung")) {
          totalBar = 34;
        } else {
          totalBar = 36;
        }
      } else {
        const model = res.model;
        if (model.match("iPhone X")) {
          totalBar = 44;
        } else {
          totalBar = 32;
        }
      }

      // 时间、信号等工具栏的高度
      let toolBar = res.statusBarHeight;
      this.tool_height = res.statusBarHeight;
      // 页面title栏的高度
      this.title_height = totalBar * 2 - toolBar;
    },


```

8.巧用 mixins
  我们可以将常用的全局方法，设置为mixins，
```js
const shareMix = {
  onShareAppMessage(res) {
    let { title, imageUrl, path, user } = getApp().globalData;
    path = user._id ? `${path}?refer=${user._id}` : path;
    return {
      title,
      imageUrl,
      path
    };
  }
} 

export default shareMix;



```

## 参考文献



[1]https://developers.weixin.qq.com/miniprogram/dev/framework/audits/scoring.html