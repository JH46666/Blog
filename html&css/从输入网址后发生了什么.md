# 从输入网址后发生了什么

## 一整套过程

1. DNS 域名解析
2. 建立tcp连接
3. 发送 http 请求
4. 服务器处理请求
5. 返回响应结果
6. 关闭tcp连接
7. 浏览器解析html
8. 浏览器布局渲染

把他们扩展一下就是
dns: 从客户端到本地服务器属于递归查询， 而dns服务器之间的交互属于迭代查询。

建立tcp连接：三次握手原理 客户端发送syn标志的数据包给服务端，服务端收到后，回传一个带有syn/ack标志的数据包已示传达确认信息，最后客户端在回传一个带有ack标志的数据包，代表握手结束，连接成功。

发送http请求：与服务器建立连接后， 就向服务器发起请求了

服务器处理请求： 服务器收到请求后由web服务器处理请求，web服务器解析用户请求，知道了需要调度哪些资源文件，在通过相应的这些资源文件处理用户请求和参数，并调用数据库信息，最后将结果通过web服务器返回给浏览器客户端。

关闭TCP连接： 与创建tcp连接的三次我握手类似，关闭tcp连接，需要4次握手。

客户端： 我这边没有数据要给你了，关闭连接吧

服务端： 好的，我看我这边还有数据要传给吗

服务端： 我这边也没有数据要传给你了，咱们可以关闭连接了

客户端： 好的。

浏览器解析 html： 渲染树与dom树不同，渲染树中并没有head、display为none等不必显示的节点。

浏览器布局渲染： 根据css样式，即每个借点在页面中的大小和位置等。html 默认是流式布局，css 和 js 会打破这种布局。改变 dom 的外观样式以及大小和位置。这时就有两个重要概念： repaint 和 reflow。

repaint（重绘）： 屏幕的一部分重画，不影响整体布局

reflow（重排）： 意味着元件的几何尺寸变了，我们需要重新验证并计算渲染树。

## 第一步 DNS 涉及到的东西

通过dns 解析域名的实际ip地址

dns 解析首先会从你的浏览器的缓存中去寻找是否有这个网址对应的ip地址，如果没有就想os系统的dns缓存中寻找，如果没有就是路由器的dns缓存，如果没有就是isp的dns缓存中寻找。
浏览器-> 系统-> 路由器-> isp

## 期间涉及到的缓存有哪些

### dns 缓存

查询浏览器以及操作系统中的DNS缓存，再查询本地host文件，如果还未找到的话，就向自己的DNS服务器查询。  浏览器缓存->系统缓存->路由器缓存->IPS服务器缓存->根域名服务器缓存->顶级域名服务器缓存->主域名服务器缓存。

1. 浏览器搜索自身的dns缓存，
2. 搜索操作系统自身的dns缓存
3. 读取本地的hosts文件，查询有无域名对应解析
4. 浏览器发起的dns

### 浏览器缓存机制

1. 查询浏览器中是否有对应网页的强缓存（Expires或Cache-Control未过期），如果命中缓存则直接取本地磁盘的html（状态码为200， 内存或者磁盘）
2. 如果没有命中强缓存，则会向浏览器发起请求（先进行下一步的TCP连接），服务器通过Etag和last-Modify来与服务器确认返回的响应是否被更改（协商缓存），若无更改返回状态码（304 Not Modified）,浏览器取本地缓存；
3. 若强缓存和协商缓存都没有命中则返回请求结果

本地存储

四个和缓存有关的
cache-control  相对时间   优先级高于 expires

expires  绝对时间

last-modified  文件最后修改的时间 response从服务器返回的标记 if-modified-since  文件最后修改的时间 request 发送给服务器与服务器做对比，

ETag 生成 hash 值

#### 这里涉及到几个状态码的意思

301永久重定向

所以浏览器会进行2次请求。第一次返回301/302

服务器响应 状态码为301+ location为新的url

浏览器会再次请求新的URL

服务器一定要重定向而不是直接发送用户想看的网页呢，

1. 用不同地址会造成缓存友好性变差，当一个页面有好几个名字时， 它可能会在缓存里出现好几次
2. 搜索引擎排名有关，会将不同的地址带到同一个网站排名下。
3. http网站跳转到https网站
4. 二级域名跳转到主域名，<http://www.abc.com> 跳转到 <http://abc.com>
5. 404页面失效跳转到新的页面

302临时重定向

 302使用的情况不太常见，因为这是个临时性的跳转，暂时性的把页面A跳转到页面B，但是最终还会使用页面A，这个情况一般就是网站短时间内进行改版，在不影响用户体验的情况下，临时把页面跳转到临时页面。

304文件未变化

401未登录
  
401 unauthorized，表示发送的请求需要有通过 HTTP 认证的认证信息

403资源不可用

forbidden 通常由于服务器上文件或目录的权限设置导致, 比如IIS或者apache设置了访问权限不当

### cdn缓存与回源

DNS 可以返回一个合适的机器的 IP 给用户，例如可以根据每台机器的负载量，该机器离用户地理位置的距离等等，这种过程就是 DNS 负载均衡，又叫做 DNS 重定向。大家耳熟能详的 CDN (Content Delivery Network)就是利用 DNS 的重定向技术，DNS 服务器会返回一个跟用户最接近的点的 IP 地址给用户，CDN 节点的服务器负责响应用户的请求，提供所需的内容。

cdn 往往用来存放静态资源

* 『缓存』就是说我们把资源 copy 一份到 cdn 服务器上这个过程。
* 『回源』就是说cdn 发现自己没有这个资源（一般是缓存的数据过期了），转头向根服务器（或者它的上层服务器）去要这个资源的过程。

1. 浏览器开始解析目标 HTML 文件,执行流的顺序为自上而下。
1. HTML 解析器将 HTML 结构转换为基础的 DOM (文档对象模型),构建 DOM 树完成后,触发 DomContendLoaded 事件。
1. CSS 解析器将 CSS 解析为 CSSOM (层叠样式表对象模型),一棵仅含有样式信息的树。
1. CSSOM 和 DOM 开始合并构成渲染树,每个节点开始包含具体的样式信息（几何信息： 位置、大小）。（称为回流）
1. 计算渲染树中个各个节点的位置信息,即布局阶段(Paint： 重绘)。
1. 将布局后的渲染树显示到界面上(Composite Layers)

![render tree](https://tva1.sinaimg.cn/large/0081Kckwgy1gkhvvfvshkj318y0m4tcj.jpg)

如果改变页面布局, 则是先通过 js 更新 dom 在经历计算样式到合成图像这个过程. 如果仅仅是非几何变化(颜色, visibility, transform), 则可以跳过布局步骤

网络进程获取到数据后，通过ipc 将数据传给渲染器进程的主线程
主线程将html 解析构造 Dom 树， 然后进行样式计算， 根据DOM树和生成好的样式生成 LayoutTree
通过遍历 layoutTree 生成绘制顺序表接着遍历 LayoutTree 生成layerTree ， 传给合成器线程按规则进行分图层
在接着就是栅格线程进行 draw quads 传回个合成器线程frame 交给 gpu 进行渲染

LayoutTree 和 DomTree 并不一定相同，而是在最后面解析出的相同。

合成器帧最后交由gpu 进行绘制

这里面有两点优化方案：

1. requestAnimationFrame 能够将js 分成更小的任务块，在每一帧时间用完前暂停 js 执行。

2. 直接通过 transform 实现的动画由于不需要经过布局绘制，  主线程 就不会跟 js 抢占执行时间。

在谈重排和重绘
两者都是改变页面样式的步骤,. 重排步骤包括 Recalculate Style、Layout、Update Layer Tree 等渲染类型事件，重绘步骤包括 Paint 和 Composite Layers 这些绘制类型事件。

## DNS 预解析

dns Prefetch, 即 dns 预获取, 是前端优化的一部分, 一般来说, 在优化中与 dns 有关的有两点: 一是减少 dns 的请求次数, 另一个就是进行 dns 预获取.

减少 dns 解析时间和次数是个很好的优化方式。DNS Prefetching 是让具有此属性的域名不需要用户点击链接就在后台解析，而域名解析和内容载入是串行的网络操作，所以这个方式能 减少用户的等待时间，提升用户体验 。

默认情况下浏览器会对页面中和当前域名（正在浏览网页的域名）不在同一个域的域名进行预获取，并且缓存结果，这就是隐式的 DNS Prefetch。如果想对页面中没有出现的域进行预获取，那么就要使用显示的 DNS Prefetch 了。

dns prefetch 应该经量的放在网页的前面, 推荐放在 \<meta charset="UTF-8">

```js
<meta http-equiv="x-dns-prefetch-control" content="on">
<link rel="dns-prefetch" href="//www.img.com">
<link rel="dns-prefetch" href="//www.api.com">
<link rel="dns-prefetch" href="//www.test.com">
```

如果要禁止隐式的 dns prefetch, 可以使用以下的标签

```js
<meta http-equiv="x-dns-prefetch-control" content="off">
```

## 协议是 https 则会做加密
