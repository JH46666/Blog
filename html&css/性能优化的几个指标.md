# 性能优化

## 指标

TTFB 第一个字节的时间 从点击链接到收到第一个字节内容的时间

FP 第一次绘制， 用户第一次看到任何像素内容的时间 白屏时间

FCP 第一次内容绘制  用户看到第一次有效内容的时间 首屏时间

FSP 首屏可视时间  第一屏内容绘制  用户看到第一屏内容的时间

LCP 第一次最大内容绘制  用户看到最大内容的时间

TTI  可交互时间 页面变为可交互的时间 （比如可响应事件）

大体上FSP约等于 FCP 或 LCP

![性能指标](https://tva1.sinaimg.cn/large/0081Kckwgy1gl00g6qerlj30yq0iut97.jpg)

1. 客户端主文档/Assets 缓存
在客户端内， 利用端侧提供的静态资源缓存能力， 将HTML和基础公共的JS 等资源，推送下发至用户侧客户端缓存。 当客户端的webView 请求资源时， 端侧可根据规则来匹配已下发的缓存包， 在匹配成功后直接从本地缓存中读取对应的HTML 和 JS 资源， 而无需请求网络，大大缩短了页面的初始化时间。

2. 数据预加载

1. 白屏时间计算

在head 标签开始加一段脚本，用于记录白屏开始时间，在head标签结束之前，加一段脚本，用于计算白屏时间，有些浏览器可以调用performance api 得出白屏结束时间，有些不支持，因此，计算方式分两种：

首屏时间计算：

对于交互少的： 由于区别不大，所以自由选择
对于大型复杂页面： 需处理更多复杂的元素，白屏时间和首屏时间相隔比较远，这时候计算白屏时间更有用
白屏时间是小于首屏时间的

performance 直接拿不到首屏时间

DOMContentLoaded 的值只能表示空白页（当前页面 body 标签里面没有内容）加载花费的时间

浏览器需要先加载 JS , 然后再通过 JS 来渲染页面内容，这个时候单页面类型首屏才算渲染完成

常见计算方式：

用户自定义打点：

MutationObserver接口

```javascript
function mountObserver () {
    if (!window.MutationObserver) {
      // 不支持 MutationObserver 的话
      console.warn('MutationObserver 不支持，首屏时间无法被采集');
      return;
    }
    
    // 每次 dom 结构改变时，都会调用里面定义的函数
    const observer = new window.MutationObserver(() => {
      const time = getTimestamp() - this.startTime; // 当前时间 - 性能开始计算时间
      
      const body = document.querySelector('body');
      let score = 0;
      
      if (body) {
        score = traverseEl(body, 1, false);
        this.observerData.push({ score, time });
      } else {
        this.observerData.push({ score: 0, time });
      }
    });
    
    // 设置观察目标，接受两个参数: target：观察目标，options：通过对象成员来设置观察选项
    // 设为 childList: true, subtree: true 表示用来监听 DOM 节点插入、删除和修改时
    observer.observe(document, { childList: true, subtree: true });
    
    this.observer = observer;
 
   
    if (document.readyState === 'complete') {
      // MutationObserver监听的最大时间，10秒，超过 10 秒将强制结束
      this.unmountObserver(10000);
    } else {
      win.addEventListener(
        'load',
        () => {
          this.unmountObserver(10000);
        },
        false
      );
    }
  }

```

lighthouse 中 我们可以得到fcp值， fcp 首次有效绘制 表示页面的主要内容开始出现在屏幕上的时间点，它是我们测量用户加载体验的主要指标。我们可以认为fcp的值就是首屏时间。

* 如果页面首屏有图片

首屏时间 = 首屏图片全部加载完毕的时刻 - window.performance.timing.navigationStart

* 如果页面首屏没有图片

首屏时间 = 页面处于稳定状态前最后一次 dom 变化的时刻 - window.performance.timing.navigationStart

FCP（First ContentFull Paint）：白屏时间（第一个文本绘制时间）

Speed Index：首屏时间

TTI（Time To Interactive）: 第一次可交互的时间

lighthouse Score（performance）：Chrome浏览器审查工具性能评分（也可以npm install -g lighthouse，编程式调用）

构建时压缩图片

排查并移除冗余依赖、静态资源

prefetch preloaded

cdn加速

gzip压缩传输

开启http2.0

白屏时间的loading动画
